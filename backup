#!/bin/bash
#
# pbrisbin 2010
#
# rewritten based on ideas from falconindy's SquashFu:
#       http://github.com/falconindy/SquashFu
#
###

errorout() { echo "error: $*" >&2; exit 1; }
message()  { echo 'usage: backup [ -d | -m | --media ] [ rsync options ]'; exit 1; }

check_lock() {
  local drive="$1"

  [[ -f "$drive/.lock" ]] && return 0

  # if we get here we fail
  errorout "$drive/.lock not found. is it mounted?"
}

[[ "$1" =~ -h|--help ]] && message

# must be root
[[ $(id -u) -eq 0 ]] || errorout 'only root can do that.'

# normal backup settings
backup_daily='/mnt/backup/daily'
backup_monthly='/mnt/backup/monthly'
includes=( /srv/http /home/patrick /etc /usr /var /boot )
excludes=( Downloads lost+found )

# my large media collection is handled specially
media_backup='/mnt/backup2'
media_includes=( /mnt/media/Music /mnt/media/Rips /mnt/media/Movies /mnt/media/TV_shows )

if [[ "$1" = '--media' ]]; then
  shift

  # do a media backup and exit
  check_lock "$media_backup"
  echo "syncing media to $media_backup/... "
  rsync -a -l --delete "$@" "${media_includes[@]}" "$media_backup/"
  exit $?
fi

case "$1" in
  -d|--daily)   backup_dir="$backup_daily"   ;;
  -m|--monthly) backup_dir="$backup_monthly" ;;
  *)            message                      ;;
esac

shift

# default
backup_dir="${backup_dir:-$backup_daily}"

# is mounted
check_lock "$backup_dir"

echo "syncing directories to $backup_dir/... "
rsync -a -l --delete --delete-excluded "$@" "${includes[@]}" ${excludes[@]/#/--exclude } "$backup_dir/"

echo 'generating package lists... '
pacman -Qqe | grep -Fvx "$(pacman -Qqm)" > "$backup_dir/paclog" || errorout 'failed creating paclisting'
pacman -Qqm > "$backup_dir/aurlog"                              || errorout 'failed creating aur listing'
